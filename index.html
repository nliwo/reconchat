<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Agent + Upload ‚Üí n8n</title>
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --muted:#93a4c7; --text:#e9eeff; --accent:#5b8cff; --danger:#ff5b6e; }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #16214a, var(--bg));
      color:var(--text);
      display:flex; min-height:100vh;
    }
    .wrap{ width:min(980px, 100%); margin:auto; padding:24px; }
    .card{
      background: rgba(18,26,51,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    header{
      padding:18px 18px 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header .title{ display:flex; flex-direction:column; gap:2px;}
    header h1{ margin:0; font-size:16px; font-weight:700; letter-spacing:.2px;}
    header .sub{ color:var(--muted); font-size:12px;}
    header .pill{
      font-size:12px; color:#dbe6ff;
      background: rgba(91,140,255,.18);
      border:1px solid rgba(91,140,255,.35);
      padding:6px 10px; border-radius:999px;
    }
    .grid{ display:grid; grid-template-columns: 1.4fr .6fr; gap:0; }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }

    .chat{
      border-right:1px solid rgba(255,255,255,.08);
      min-height:520px;
      display:flex; flex-direction:column;
    }
    @media (max-width: 860px){ .chat{ border-right:none; border-bottom:1px solid rgba(255,255,255,.08); } }
    .messages{
      padding:16px;
      flex:1;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      scroll-behavior:smooth;
    }
    .msg{
      max-width: 88%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.25;
      font-size:14px;
      white-space:pre-wrap;
      word-break:break-word;
      border:1px solid rgba(255,255,255,.08);
    }
    .msg.user{ align-self:flex-end; background: rgba(91,140,255,.16); border-color: rgba(91,140,255,.28); }
    .msg.bot{ align-self:flex-start; background: rgba(255,255,255,.06); }
    .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:11px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .composer{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; align-items:flex-end;
      background: rgba(0,0,0,.08);
    }
    textarea{
      width:100%;
      resize:none;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,16,35,.7);
      color:var(--text);
      padding:10px 10px;
      outline:none;
      min-height:44px;
      max-height:140px;
      font-size:14px;
    }
    button{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      background: var(--accent);
      color:white;
      font-weight:700;
      cursor:pointer;
      min-width:92px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .tinybtn{
      background: transparent;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      min-width:auto;
      padding:8px 10px;
      font-weight:600;
    }

    .side{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"]{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,16,35,.7);
      color:var(--text);
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    .drop{
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:14px;
      text-align:center;
      color:var(--muted);
      transition:.15s ease;
      user-select:none;
    }
    .drop.dragover{ border-color: rgba(91,140,255,.7); background: rgba(91,140,255,.10); color:#dbe6ff; }
    .files{
      display:flex; flex-direction:column; gap:8px;
      max-height:220px; overflow:auto;
      padding-right:4px;
    }
    .file{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      font-size:13px;
    }
    .file .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .file .rm{
      background: transparent;
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-weight:700;
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.35; }
    .status{
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      color: var(--muted);
      min-height:40px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .status .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); }
    .status.ok{ color:#bfffd2; border-color: rgba(0,255,140,.18); background: rgba(0,255,140,.06); }
    .status.err{ color:#ffd0d6; border-color: rgba(255,91,110,.25); background: rgba(255,91,110,.07); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="title">
          <h1>Chat Agent -</h1>
          <div class="sub">Historial persistente + archivos ‚Üí webhook n8n</div>
        </div>
        <div class="pill" id="convPill"></div>
      </header>

      <div class="grid">
        <section class="chat">
          <div id="messages" class="messages"></div>

          <div class="composer">
            <button id="clearBtn" class="tinybtn" title="Borrar conversaci√≥n guardada">Reset</button>
            <textarea id="text" placeholder="Escrib√≠‚Ä¶ (Enter env√≠a, Shift+Enter salto)"></textarea>
            <button id="sendBtn">Enviar</button>
          </div>
        </section>

        <aside class="side">
          <div class="field">
            <label>URL del webhook n8n</label>
            <input id="webhook" type="text" value="https://automate.persiscal.io/webhook/1b3a54c0-ca1e-42bc-8556-8ef16bc85f2c/chat" />
          </div>

          <div id="drop" class="drop">
            <div style="font-weight:700; margin-bottom:6px;">Arrastr√° archivos ac√°</div>
            <div class="hint">o <span style="color:#dbe6ff; text-decoration:underline; cursor:pointer" id="browse">seleccion√°</span> m√∫ltiples archivos</div>
            <input id="fileInput" type="file" multiple style="display:none" />
          </div>

          <div class="files" id="fileList"></div>

          <div class="status" id="status">
            <span>Listo</span>
            <span class="badge" id="badge">idle</span>
          </div>

          <div class="hint">
            Se env√≠a: <code>message</code>, <code>conversationId</code>, <code>history</code> (JSON) + <code>files</code>.
            <br/>Tu workflow en n8n puede usar el historial para mantener contexto del agente.
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    // ========= Storage keys =========
    const CONV_ID_KEY = "mini_agent_conversation_id_v1";
    const HISTORY_KEY = "mini_agent_history_v1";

    // ========= UI refs =========
    const $ = (id) => document.getElementById(id);
    const messagesEl = $("messages");
    const textEl = $("text");
    const sendBtn = $("sendBtn");
    const clearBtn = $("clearBtn");
    const webhookEl = $("webhook");
    const statusEl = $("status");
    const badgeEl = $("badge");
    const dropEl = $("drop");
    const fileInput = $("fileInput");
    const fileList = $("fileList");
    const browse = $("browse");
    const convPill = $("convPill");

    // ========= State =========
    let files = [];
    let history = loadHistory(); // [{role:'user'|'assistant', content:'...', ts:number}]

    function getConversationId() {
      let id = localStorage.getItem(CONV_ID_KEY);
      if (!id) {
        id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2));
        localStorage.setItem(CONV_ID_KEY, id);
      }
      return id;
    }

    function saveHistory() {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }

    function setStatus(kind, text, badge) {
      statusEl.classList.remove("ok","err");
      if (kind) statusEl.classList.add(kind);
      statusEl.firstElementChild.textContent = text;
      badgeEl.textContent = badge || "idle";
    }

    function renderMessage(role, content, ts, metaExtra="") {
      const msg = document.createElement("div");
      msg.className = "msg " + (role === "user" ? "user" : "bot");
      msg.textContent = content;

      const metaEl = document.createElement("div");
      metaEl.className = "meta";
      const t = new Date(ts || Date.now());
      const who = role === "user" ? "Vos" : "Agent";
      metaEl.innerHTML = `<span>${who}</span><span>${t.toLocaleTimeString()}</span>` + (metaExtra ? `<span>¬∑ ${metaExtra}</span>` : "");

      const wrap = document.createElement("div");
      wrap.style.display = "flex";
      wrap.style.flexDirection = "column";
      wrap.style.gap = "4px";
      wrap.appendChild(msg);
      wrap.appendChild(metaEl);

      messagesEl.appendChild(wrap);
    }

    function renderAllHistory() {
      messagesEl.innerHTML = "";
      for (const m of history) renderMessage(m.role, m.content, m.ts);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function pushToHistory(role, content) {
      history.push({ role, content, ts: Date.now() });
      saveHistory();
    }

    function renderFiles() {
      fileList.innerHTML = "";
      if (files.length === 0) {
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "No hay archivos adjuntos.";
        fileList.appendChild(empty);
        return;
      }
      files.forEach((f, idx) => {
        const row = document.createElement("div");
        row.className = "file";
        const left = document.createElement("div");
        left.style.minWidth = "0";
        left.innerHTML = `<div class="name"><b>${f.name}</b></div><div style="color:var(--muted); font-size:11px;">${(f.size/1024).toFixed(1)} KB</div>`;
        const rm = document.createElement("button");
        rm.className = "rm";
        rm.textContent = "Quitar";
        rm.onclick = () => { files.splice(idx, 1); renderFiles(); };
        row.appendChild(left);
        row.appendChild(rm);
        fileList.appendChild(row);
      });
    }

    function addFiles(newFiles) {
      const key = (f) => `${f.name}|${f.size}|${f.lastModified}`;
      const existing = new Set(files.map(key));
      for (const f of newFiles) if (!existing.has(key(f))) files.push(f);
      renderFiles();
    }

    async function sendToN8n(message) {
      const url = webhookEl.value.trim();
      if (!url || !url.startsWith("http")) throw new Error("Configur√° una URL v√°lida del webhook de n8n.");

      const form = new FormData();
      form.append("message", message);
      form.append("conversationId", getConversationId());

      // Mandamos el historial completo (sin archivos, solo texto/roles)
      form.append("history", JSON.stringify(history));

      for (const f of files) form.append("files", f, f.name);

      const res = await fetch(url, { method: "POST", body: form });
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await res.json() : await res.text();

      if (!res.ok) {
        const msg = typeof data === "string" ? data : JSON.stringify(data);
        throw new Error(`Webhook error ${res.status}: ${msg}`);
      }
      return data;
    }

    function extractAgentText(payload) {
      if (typeof payload === "string") return payload || "(sin respuesta)";
      if (Array.isArray(payload)) {
        const first = payload[0] || {};
        return first.output || first.text || JSON.stringify(first);
      }
      return payload.output || payload.text || JSON.stringify(payload);
    }

    async function onSend() {
      const message = textEl.value.trim();
      if (!message && files.length === 0) return;

      // 1) Mostrar + guardar el mensaje del usuario
      renderMessage("user", message || "(adjuntos)", Date.now(), files.length ? `${files.length} archivo(s)` : "");
      pushToHistory("user", message || "(adjuntos)");

      textEl.value = "";
      setStatus("", "Enviando‚Ä¶", "sending");
      sendBtn.disabled = true;

      try {
        const payload = await sendToN8n(message);
        const reply = extractAgentText(payload);

        // 2) Mostrar + guardar la respuesta del agente
        renderMessage("assistant", reply, Date.now());
        pushToHistory("assistant", reply);

        setStatus("ok", "Enviado", "ok");
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Si quer√©s que los adjuntos se limpien despu√©s de enviar:
        // files = []; renderFiles();
      } catch (err) {
        renderMessage("assistant", "No pude enviar al webhook. " + err.message, Date.now());
        pushToHistory("assistant", "ERROR: " + err.message);
        setStatus("err", "Error al enviar", "error");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // ========= Events =========
    $("sendBtn").addEventListener("click", onSend);
    $("clearBtn").addEventListener("click", () => {
      if (!confirm("¬øSeguro? Esto borra la conversaci√≥n guardada (localStorage).")) return;
      history = [];
      localStorage.removeItem(HISTORY_KEY);
      // Opcional: tambi√©n reiniciar conversationId
      // localStorage.removeItem(CONV_ID_KEY);

      messagesEl.innerHTML = "";
      files = [];
      renderFiles();
      setStatus("", "Listo", "idle");
    });

    textEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); onSend(); }
    });

    browse.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (e) => addFiles(e.target.files));

    ["dragenter","dragover"].forEach(evt => {
      dropEl.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropEl.classList.add("dragover"); });
    });
    ["dragleave","drop"].forEach(evt => {
      dropEl.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropEl.classList.remove("dragover"); });
    });
    dropEl.addEventListener("drop", (e) => addFiles(e.dataTransfer.files));

    // ========= Init =========
    const convId = getConversationId();
    convPill.textContent = "conv: " + convId.slice(0, 8);
    renderFiles();
    if (history.length) {
      renderAllHistory();
    } else {
      renderMessage("assistant", "Hola üëã. Esta conversaci√≥n queda guardada y se ve completa. Envi√° mensajes y adjunt√° archivos si quer√©s.", Date.now());
      pushToHistory("assistant", "Hola üëã. Esta conversaci√≥n queda guardada y se ve completa. Envi√° mensajes y adjunt√° archivos si quer√©s.");
    }
  </script>
</body>
</html>

